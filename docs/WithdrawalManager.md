# WithdrawalManager - –°–∏—Å—Ç–µ–º–∞ –í—ã–≤–æ–¥–∞ –°—Ä–µ–¥—Å—Ç–≤ üîê

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

**WithdrawalManager** - —ç—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ hash-based –∑–∞–ø—Ä–æ—Å—ã. –°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ–ª–∫–∏ –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –Ω–∞ –≤—ã–≤–æ–¥.

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

### DEAD SIMPLE –õ–æ–≥–∏–∫–∞:
1. **Request** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
2. **Hash** ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π hash –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞  
3. **Approve** ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü –æ–¥–æ–±—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
4. **Unstake** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–≤–æ–¥–∏—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

### WithdrawalRequest
```solidity
struct WithdrawalRequest {
    address user;           // –í–ª–∞–¥–µ–ª–µ—Ü –∑–∞–ø—Ä–æ—Å–∞
    uint256 shares;         // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ sCELL —Ç–æ–∫–µ–Ω–æ–≤
    uint256 amount;         // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ CELL
    uint256 blockNumber;    // –ë–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    bool isApproved;        // –°—Ç–∞—Ç—É—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è
}
```

### –•—Ä–∞–Ω–∏–ª–∏—â–µ
```solidity
mapping(bytes32 => WithdrawalRequest) public withdrawalQueue;
mapping(address => bytes32[]) public userRequests;
```

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –§—É–Ω–∫—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –ó–∞–ø—Ä–æ—Å–∞
```solidity
function requestWithdrawal(uint256 shares) external virtual
```
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å sCELL —Ç–æ–∫–µ–Ω–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç amount = shares √ó exchangeRate / 1e18
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π hash –æ—Ç (user, shares, amount, blockNumber)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ withdrawalQueue
5. **–ù–ï–ú–ï–î–õ–ï–ù–ù–û —Å–∂–∏–≥–∞–µ—Ç sCELL —Ç–æ–∫–µ–Ω—ã**

### –û–¥–æ–±—Ä–µ–Ω–∏–µ –ó–∞–ø—Ä–æ—Å–æ–≤
```solidity
function approveWithdrawal(bytes32 requestHash) external virtual
function approveWithdrawals(bytes32[] calldata requestHashes) external virtual
```
- –¢–æ–ª—å–∫–æ owner –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã
- –ò–∑–º–µ–Ω—è–µ—Ç isApproved = true –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ hash
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –í—ã–≤–æ–¥ –°—Ä–µ–¥—Å—Ç–≤
```solidity
function unstake(bytes32 requestHash) external virtual
```
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å msg.sender
- –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–æ–±—Ä–µ–Ω
- –ü–æ—Å–ª–µ –≤—ã–≤–æ–¥–∞ –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã

## üîê –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Hash –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
```solidity
function getRequestHash(
    address user,
    uint256 shares,
    uint256 amount,
    uint256 blockNumber
) public pure returns (bytes32) {
    return keccak256(abi.encodePacked(user, shares, amount, blockNumber));
}
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ü–æ–¥–¥–µ–ª–∫–∏
- Hash –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- blockNumber –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—ã–π hash —É–Ω–∏–∫–∞–ª—å–Ω—ã–º
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –º–µ–Ω—è–µ—Ç hash –ø–æ–ª–Ω–æ—Å—Ç—å—é

## üìä View –§—É–Ω–∫—Ü–∏–∏

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ó–∞–ø—Ä–æ—Å—ã
```solidity
function getUserRequests(address user) external view returns (bytes32[] memory)
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ hash –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –í—ã–≤–æ–¥–∞
```solidity
function canUnstake(bytes32 requestHash) external view returns (bool)
```
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ msg.sender –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ –¥–∞–Ω–Ω–æ–º—É hash

## üìù –°–æ–±—ã—Ç–∏—è

```solidity
event WithdrawalRequested(
    address indexed user,
    bytes32 indexed requestHash,
    uint256 shares,
    uint256 amount,
    uint256 blockNumber
);

event WithdrawalApproved(
    bytes32 indexed requestHash,
    address indexed user
);

event WithdrawalCompleted(
    bytes32 indexed requestHash,  
    address indexed user,
    uint256 amount
);
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π –¶–∏–∫–ª –ó–∞–ø—Ä–æ—Å–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ (requestWithdrawal)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —É–∫–∞–∑—ã–≤–∞–µ—Ç shares
    ‚Üì
–°–∏—Å—Ç–µ–º–∞ ‚Üí —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç amount –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É
    ‚Üì 
Hash ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç (user, shares, amount, block)
    ‚Üì
sCELL ‚Üí —Å–∂–∏–≥–∞—é—Ç—Å—è –ù–ï–ú–ï–î–õ–ï–ù–ù–û
    ‚Üì
–ó–∞–ø—Ä–æ—Å ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ mapping
```

### 2. –û–¥–æ–±—Ä–µ–Ω–∏–µ (approveWithdrawal)
```
Owner ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –ø–æ hash
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí –∑–∞–ø—Ä–æ—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω
    ‚Üì
–°—Ç–∞—Ç—É—Å ‚Üí isApproved = true
    ‚Üì
Event ‚Üí WithdrawalApproved
```

### 3. –í—ã–≤–æ–¥ (unstake)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç hash —Å–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü + –æ–¥–æ–±—Ä–µ–Ω
    ‚Üì
–ü–µ—Ä–µ–≤–æ–¥ ‚Üí CELL —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Üì
–£–¥–∞–ª–µ–Ω–∏–µ ‚Üí –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã
```

## üõ°Ô∏è –ó–∞—â–∏—Ç–Ω—ã–µ –ú–µ—Ö–∞–Ω–∏–∑–º—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ _requestWithdrawal
- `shares > 0` - –∑–∞–ø—Ä–µ—Ç –Ω—É–ª–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `_getUserShares(msg.sender) >= shares` - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤
- `amount > 0` - –∑–∞–ø—Ä–µ—Ç –º–∏–∫—Ä–æ-—Å—É–º–º

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ _unstake  
- `request.user == msg.sender` - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü
- `request.isApproved` - —Ç–æ–ª—å–∫–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üèÜ –ö–ª—é—á–µ–≤—ã–µ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –°–∂–∏–≥–∞–Ω–∏–µ
- sCELL —Ç–æ–∫–µ–Ω—ã —Å–∂–∏–≥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –±—É–¥—É—â–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
- –°—É–º–º–∞ CELL —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ó–∞–ø—Ä–æ—Å—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º
- –†–∞–∑–Ω—ã–µ —Å—É–º–º—ã –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

### Hash-Based Security
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å requestHash
- –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–∫–∞–∑—É–µ–º–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ª–ª–∏–∑–∏–π

## üîß –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –§—É–Ω–∫—Ü–∏–∏

–ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```solidity
function _getExchangeRate() internal view virtual returns (uint256);
function _getUserShares(address user) internal view virtual returns (uint256);
function _transferAndBurnShares(address user, uint256 shares) internal virtual;
function _transferAssets(address user, uint256 assets) internal virtual;
```

–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å–ª–µ–¥—É—é—â–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ (ValoraCore). 