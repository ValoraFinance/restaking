# Система Снятия Средств (Withdrawal System)

## Обзор

Новая система снятия средств в Valora Finance основана на **недельном батчинге** с фиксированными временными окнами. Это обеспечивает оптимальную экономию газа, предсказуемость для пользователей и справедливое распределение exchange rate.

## Ключевые Принципы

### 1. Недельные Батчи (Weekly Batches)
- Все заявки группируются по неделям
- Каждая неделя имеет фиксированный exchange rate
- Exchange rate устанавливается при первой заявке недели
- Все пользователи в рамках одной недели получают одинаковый rate

### 2. Временные Окна
```
Понедельник 00:00 - Вторник 00:00: Окно подачи заявок
Вторник 00:00 - Понедельник 00:00: Ожидание
Понедельник 00:00 - Понедельник 00:00 (+1 неделя): Окно снятия
```

### 3. Фиксация Exchange Rate
- Rate фиксируется при первой заявке недели
- Все последующие заявки используют тот же rate
- Это защищает от MEV и обеспечивает справедливость

## Техническая Архитектура

### Структуры Данных

```solidity
struct WeeklyBatch {
    uint256 totalShares;           // Общее количество shares в батче
    uint256 totalAssets;           // Общее количество assets по фиксированному rate
    uint256 exchangeRate;          // Фиксированный exchange rate
    uint256 requestDeadline;       // Когда закрывается окно заявок
    uint256 withdrawalStart;       // Когда открывается окно снятия
    uint256 withdrawalEnd;         // Когда закрывается окно снятия  
    bool isFinalized;              // Батч финализирован админом
}

struct UserRequest {
    uint256 shares;                // Shares пользователя
    uint256 assets;                // Assets по фиксированному rate
    bool isWithdrawn;              // Пользователь уже снял средства
}
```

### Основные Функции

#### `requestWithdrawal(uint256 shares)`
**Назначение:** Подача заявки на снятие средств

**Логика:**
1. Проверяет, что окно подачи заявок открыто
2. Инициализирует батч, если это первая заявка недели
3. Фиксирует текущий exchange rate для батча
4. Рассчитывает количество assets по фиксированному rate
5. Сжигает shares пользователя
6. Сохраняет заявку в батче

**Ограничения:**
- Можно подать только одну заявку в неделю
- Только в понедельник (24 часа)

#### `completeWithdrawal(uint256 week)`
**Назначение:** Завершение снятия средств за конкретную неделю

**Логика:**
1. Проверяет, что окно снятия открыто
2. Проверяет наличие заявки пользователя
3. Переводит рассчитанное количество assets
4. Помечает заявку как выполненную

**Ограничения:**
- Доступно только через неделю после подачи заявки
- Окно снятия длится одну неделю

#### `finalizeBatch()`
**Назначение:** Финализация батча администратором

**Логика:**
1. Закрывает текущий батч для новых заявок
2. Переходит к следующей неделе
3. Подготавливает систему к новому батчу

### Управление Временем

#### Расчет Недель
```solidity
function _getCurrentWeek() internal view returns (uint256) {
    uint256 genesisMonday = 1704067200; // Jan 1, 2024 00:00 UTC (Monday)
    return (block.timestamp - genesisMonday) / WEEK_DURATION;
}
```

#### Проверка Окон
```solidity
function _isRequestWindowOpen() internal view returns (bool) {
    uint256 weekStart = _getWeekStart(currentWeek);
    uint256 requestDeadline = weekStart + REQUEST_WINDOW;
    
    return block.timestamp >= weekStart && block.timestamp <= requestDeadline;
}
```

## Преимущества Системы

### 1. Экономия Газа
- Батчинг снижает количество транзакций
- Оптимизированное хранение данных
- Эффективные проверки временных окон

### 2. Справедливость
- Фиксированный exchange rate для всех участников батча
- Защита от MEV-атак
- Равные условия для всех пользователей

### 3. Предсказуемость
- Четкие временные окна
- Известные правила работы системы
- Прозрачный процесс снятия

### 4. Безопасность
- Защита от реентрантности
- Проверки временных ограничений
- Контроль доступа для критических функций

## Жизненный Цикл Заявки

```
1. Понедельник 00:00 - Пользователь подает заявку
   ↓
2. Фиксируется exchange rate
   ↓
3. Shares сжигаются, assets рассчитываются
   ↓
4. Вторник 00:00 - Админ финализирует батч
   ↓
5. Следующий понедельник 00:00 - Открывается окно снятия
   ↓
6. Пользователь снимает средства
   ↓
7. Следующий понедельник 00:00 - Окно закрывается
```

## Обработка Исключительных Ситуаций

### Просроченные Заявки
- Если пользователь не снял средства в течение недели
- Админ может вызвать `cleanupExpiredRequests()`
- Shares возвращаются пользователю
- Assets освобождаются в пуле

### Аварийные Ситуации
- Система поддерживает паузу через `AdminManager`
- Возможность отключения снятий
- Upgrade через UUPS proxy

## Интеграция с ValoraCore

`WithdrawalManager` наследуется `ValoraCore` и реализует абстрактные методы:

```solidity
function _getExchangeRate() internal view override returns (uint256)
function _getUserShares(address user) internal view override returns (uint256)  
function _transferAndBurnShares(address user, uint256 shares) internal override
function _transferAssets(address user, uint256 assets) internal override
function _returnShares(address user, uint256 shares) internal override
```

Это обеспечивает полную интеграцию с основной логикой контракта без дублирования кода.

## Мониторинг и Аналитика

### События (Events)
- `WithdrawalRequested` - заявка подана
- `BatchFinalized` - батч финализирован  
- `WithdrawalCompleted` - снятие завершено
- `WithdrawalExpired` - заявка просрочена

### View Функции
- `getUserActiveWeeks()` - активные недели пользователя
- `getWeeklyBatch()` - информация о батче
- `isRequestWindowOpen()` - статус окна заявок
- `getTimeUntilNextWindow()` - время до следующего окна

Эта система обеспечивает эффективное, справедливое и безопасное управление снятием средств в протоколе Valora Finance. 